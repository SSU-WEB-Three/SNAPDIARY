<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¹ êµë†€ì´ UI</title>
  <link rel="stylesheet" href="/css/blockstyle.css">
</head>
<body>
  <div class="container">
    <div class="floating-buttons">
      <button id="saveBtn">ì €ì¥í•˜ê¸°</button>
      <button onclick="addShape('triangle large')">í° ì‚¼ê°í˜•</button>
      <button onclick="addShape('triangle small')">ì‘ì€ ì‚¼ê°í˜•</button>
      <button onclick="addShape('square')">ì •ì‚¬ê°í˜•</button>
      <button onclick="addShape('circle')">ì›</button>
      <button onclick="addShape('star')">ë³„</button>  
    </div>
    <div class="main">
      <div class="header1">ë¸”ë¡ ë°°ì¹˜í•˜ê¸°</div>
      <div class="canvas"></div>
    </div>
  </div>

  
<script>
  const userId = "<%= userId %>";
  const mapId = "<%= mapId %>";

  let currentKeywordCount = 0;
  let currentBlockCount = 0;

  async function fetchKeywordCount() {
    try {
      const res = await fetch(`/api/keywords/count/${userId}`);
      const data = await res.json();
      currentKeywordCount = data.count;
    } catch (err) {
      console.error("í‚¤ì›Œë“œ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:", err);
    }
  }

  window.addEventListener("DOMContentLoaded", async () => {
    await fetchKeywordCount();

    if (mapId) {
      try {
        const res = await fetch(`/api/blockmap/${mapId}`);
        const mapData = await res.json();
        if (!mapData || !mapData.block_id) return;

        const canvas = document.querySelector('.canvas');
        mapData.block_id.forEach(block => {
          const newBlock = document.createElement('div');
          newBlock.className = `block ${block.shape_type}`;
          newBlock.style.left = `${block.x_pos}px`;
          newBlock.style.top = `${block.y_pos}px`;
          newBlock.style.backgroundColor = block.color || '#FFA500';
          newBlock.dataset.shape = block.shape_type;
          
          const scale = block.scale || 1;
          const rotation = block.rotation_degree || 0;
          newBlock.style.transform = `scale(${scale}) rotate(${rotation}deg)` + (block.shape_type === 'parallelogram' ? ' skew(-30deg)' : '');
          newBlock.dataset.scale = scale;
          newBlock.dataset.rotation = rotation;
          newBlock.dataset.tag = block.tag || '';

          if (block.tag) {
            const tagLabel = document.createElement('span');
            tagLabel.textContent = block.tag;
            newBlock.appendChild(tagLabel);
          }

          makeDraggableAndRotatable(newBlock);
          canvas.appendChild(newBlock);
          currentBlockCount++;
        });
      } catch (err) {
        console.error("ë¸”ë¡ ë§µ ë¡œë”© ì‹¤íŒ¨:", err);
      }
    }
  });

  function addShape(type) {
    if (currentBlockCount >= currentKeywordCount) {
      alert("ì˜¤ëŠ˜ ì…ë ¥í•œ í‚¤ì›Œë“œ ìˆ˜ë§Œí¼ë§Œ ë¸”ë¡ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    const canvas = document.querySelector('.canvas');
    const newBlock = document.createElement('div');
    newBlock.className = `block ${type}`;
    newBlock.style.left = '100px';
    newBlock.style.top = '100px';
    newBlock.style.transform = '';
    newBlock.dataset.shape = type;

    makeDraggableAndRotatable(newBlock);
    canvas.appendChild(newBlock);

    currentBlockCount++;
  }

  function makeDraggableAndRotatable(block) {
  let angle = 0;
  let dragged = false;
  let scaleOptions = [1, 1.5, 2, 2.5, 3, 3.5, 4, 0.5];
  let scaleIndex = 0;
  let scale = scaleOptions[scaleIndex];

  // íšŒì „ ì¢Œí´ë¦­
  block.addEventListener('click', (e) => {
    e.stopPropagation();
    createOptionPanel(block);
  });

  // ìƒ‰ìƒ ë³€ê²½ ìš°í´ë¦­
  block.addEventListener('contextmenu', (e) => {
  e.preventDefault();
});

  // ğŸ¯ ë“œë˜ê·¸ ì´ë™
  block.addEventListener('mousedown', (e) => {
    e.preventDefault();
    
    const canvasRect = document.querySelector('.canvas').getBoundingClientRect();
    const blockRect = block.getBoundingClientRect();

    const shiftX = e.clientX - blockRect.left;
    const shiftY = e.clientY - blockRect.top;
    dragged = false;

    function onMouseMove(e) {
      block.style.left = `${e.clientX - canvasRect.left - shiftX}px`;
      block.style.top = `${e.clientY - canvasRect.top - shiftY}px`;
      dragged = true;
    }

    function onMouseUp() {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });

  block.ondragstart = () => false;

  // ğŸ”„ ë³€í™˜ ì ìš© í•¨ìˆ˜
  function applyTransform() {
    block.style.transform = `scale(${scale}) rotate(${angle}deg)`;
    if (block.classList.contains('parallelogram')) {
      block.style.transform += ' skew(-30deg)';
    }
    block.dataset.scale = scale;
    block.dataset.rotation = angle;
  }
}


  function extractBlockData() {
  const blocks = document.querySelectorAll('.block');
  return Array.from(blocks).map(block => {
    const style = window.getComputedStyle(block);
    const transform = style.transform;
    let rotation = 0;
    let scale = 1;

    if (transform && transform !== 'none') {
      const values = transform.match(/matrix\(([^)]+)\)/);
      if (values) {
        const parts = values[1].split(', ');
        const a = parseFloat(parts[0]);
        const b = parseFloat(parts[1]);
        rotation = Math.round(Math.atan2(b, a) * (180 / Math.PI));
        scale = Math.sqrt(a * a + b * b); // scaleX ê¸°ì¤€
      }
    }

    const label = block.querySelector('span');
    const tag = label ? label.textContent : '';

    return {
      shape_type: block.dataset.shape,
      color: style.backgroundColor || '#FFA500',
      x_pos: parseInt(block.style.left || 0),
      y_pos: parseInt(block.style.top || 0),
      scale: parseFloat(block.dataset.scale || 1),
      rotation_degree: parseInt(block.dataset.rotation || 0),
      tag: block.dataset.tag || '',                 // âœ… ì§ì ‘ ì¶”ì¶œí•œ ê°’ ì‚¬ìš©
      created_at: new Date().toISOString(),
      keyword_id: null
    };
  });
}

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const blockDataList = extractBlockData();

    try {
      const res = await fetch('/save-blocks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          blockDataList,
          map_id: mapId,
          user_id: userId
        })
      });

      if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
      const msg = await res.text();
      alert(msg);
    } catch (err) {
      console.error("ì €ì¥ ì‹¤íŒ¨:", err);
      alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  });
function createOptionPanel(block) {
  remove_exist_option_panel();

  const panel = document.createElement('div');
  panel.className = 'option-panel';
  panel.style.position = 'absolute';
  panel.style.left = `${block.offsetLeft + block.offsetWidth + 10}px`;
  panel.style.top = `${block.offsetTop}px`;
  panel.style.backgroundColor = '#fff';
  panel.style.border = '1px solid #aaa';
  panel.style.borderRadius = '8px';
  panel.style.padding = '8px';
  panel.style.display = 'flex';
  panel.style.flexDirection = 'column';
  panel.style.zIndex = 1000;

  // ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
  const createButton = (label, onClick) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.style.marginBottom = '6px';
    btn.style.fontSize = '12px';
    btn.style.cursor = 'pointer';
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      onClick();
    });
    return btn;
  };

  // íšŒì „
  let angle = parseInt(block.dataset.rotation || 0);
  panel.appendChild(createButton('ğŸ” íšŒì „', () => {
    angle = (angle + 45) % 360;
    block.dataset.rotation = angle; // âœ… dataset ì €ì¥
    applyTransform();
  }));

  // í¬ê¸°
  const scaleOptions = [1, 1.5, 2, 2.5, 3, 0.5];
  let scale = parseFloat(block.dataset.scale || 1);
  let scaleIndex = scaleOptions.indexOf(scale);
  if (scaleIndex === -1) scaleIndex = 0;
  panel.appendChild(createButton('â†”ï¸ í¬ê¸°', () => {
    scaleIndex = (scaleIndex + 1) % scaleOptions.length;
    scale = scaleOptions[scaleIndex];
    block.dataset.scale = scale; // âœ… dataset ì €ì¥
    applyTransform();
  }));

  // ìƒ‰ìƒ
  panel.appendChild(createButton('ğŸ¨ ìƒ‰ìƒ', () => {
    const picker = document.createElement('input');
    picker.type = 'color';
    picker.style.position = 'absolute';
    picker.style.zIndex = 2000;
    document.body.appendChild(picker);
    picker.click();
    picker.addEventListener('input', () => {
      block.style.backgroundColor = picker.value;
      // ìƒ‰ìƒì€ styleì—ì„œ ë°”ë¡œ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ë”°ë¡œ datasetì— ì•ˆ ë„£ì–´ë„ ë¨
      picker.remove();
    });
    picker.addEventListener('blur', () => picker.remove());
  }));

  // íƒœê·¸
  panel.appendChild(createButton('ğŸ”  íƒœê·¸', () => {
    const tag = prompt("íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    if (tag) {
      let label = block.querySelector('span');
      if (!label) {
        label = document.createElement('span');
        block.appendChild(label);
      }
      label.textContent = tag;
      block.dataset.tag = tag; // âœ… dataset ì €ì¥
    }
  }));

  // ì‚­ì œ
  panel.appendChild(createButton('âŒ ì‚­ì œ', () => {
    block.remove();
    panel.remove();
    currentBlockCount--;
  }));

  // ë³€í™˜ ì ìš© í•¨ìˆ˜
  function applyTransform() {
    block.style.transform = `scale(${scale}) rotate(${angle}deg)`;
    if (block.classList.contains('parallelogram')) {
      block.style.transform += ' skew(-30deg)';
    }
  }

  document.querySelector('.canvas').appendChild(panel);

  // ì˜µì…˜ íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ì œê±°
  window.addEventListener('click', (e) => {
    if (
      e.target.closest('.option-panel') ||
      e.target.classList.contains('block')
    ) return;

    remove_exist_option_panel();
  });
}


function remove_exist_option_panel() {
  const panel = document.querySelector('.option-panel');
  if (panel) panel.remove();
}




</script>

</body>
</html>
