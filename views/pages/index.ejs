<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Snapnote</title>
  <link rel="stylesheet" href="./css/index.css">
</head>
<body>
  <!-- ë©”ì¸ ì˜ì—­ -->
  <div class="main-container">
    <!-- ì™¼ìª½ í° ì¹´ë“œì™€ ê²€ìƒ‰ ì˜ì—­ -->
    <div class="left-block">
      <div class="large-card" id="interactive-card">
        <div class="card-header"></div>
        <div class="log-container" id="log-container"></div>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="ì˜¤ëŠ˜ì˜ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”" id="search-input">
        <button class="search-btn" id="search-btn">ğŸ”</button>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì¹´ë“œ -->
    <div class="small-card-container">
      <div class="small-card" id="quote-card">
        <div class="card-header"></div>
        <p>ì˜¤ëŠ˜ì˜ ëª…ì–¸</p>
        <p id="quote-text">ì˜¤ëŠ˜ì˜ ëª…ì–¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <p id="quote-author" class="quote-author"></p>
      </div>
      <div class="small-card">
        <div class="card-header"></div>
        <p>ìµœê·¼ ì»¤ë®¤ë‹ˆí‹°</p>
        <ul id="recent-community-list"></ul>
      </div>
    </div>
  </div>

<script>
const greetings = [
  "ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë– ì‹ ê°€ìš”? ì˜¤ëŠ˜ë„ í™œê¸°ì°¨ê²Œ ì‹œì‘í•´ë³´ì„¸ìš”!",
  "ì˜¤ëŠ˜ë„ í™œê¸°ì°¨ê²Œ ì‹œì‘í•´ë³¼ê¹Œìš”? ì–´ë–¤ ì¼ì´ë“  ì°¨ë¶„í•˜ê²Œ í•´ë‚˜ê°€ë©´ ì˜ ë  ê±°ì˜ˆìš”!",
  "ë¬´ìŠ¨ ì¼ì´ë“  ì˜ í’€ë¦¬ê¸¸ ë°”ë„ê²Œìš”! ì˜¤ëŠ˜ì€ ì–´ì œë³´ë‹¤ ë” ë‚˜ì€ í•˜ë£¨ê°€ ë  ê±°ì˜ˆìš”!",
  "í•˜ë£¨ì˜ ì‹œì‘ì„ ê¸°ë¶„ ì¢‹ê²Œ ë§Œë“¤ì–´ ë´…ì‹œë‹¤! ì‘ì€ ë³€í™”ë„ ë‚˜ë¥¼ ì„±ì¥ì‹œí‚µë‹ˆë‹¤.",
  "ê¸°ë¶„ ì¢‹ì€ í•˜ë£¨ê°€ ë˜ê¸¸ ë°”ëë‹ˆë‹¤! ì˜¤ëŠ˜ í•˜ë£¨ë„ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”.",
  "ì–´ë–¤ ì¼ì´ë“  ì°¨ë¶„í•˜ê²Œ í•´ë‚˜ê°€ë©´ ì˜ ë  ê±°ì˜ˆìš”! ì‘ì€ ì„±ì·¨ë„ ì†Œì¤‘í•˜ê²Œ ì—¬ê²¨ë³´ì„¸ìš”.",
  "ì˜¤ëŠ˜ í•˜ë£¨ë„ í™”ì´íŒ…! ì§€ì¹˜ë”ë¼ë„ ì ê¹ ì‰¬ì–´ê°€ë„ ê´œì°®ì•„ìš”.",
  "ì¢‹ì€ ì¼ì´ ê°€ë“í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”! ê°€ë”ì€ ê³„íší•˜ì§€ ì•Šì€ ì¼ì´ ë” íŠ¹ë³„í•˜ë‹µë‹ˆë‹¤.",
  "ì˜¤ëŠ˜ì€ ë¬´ì—‡ì„ í•´ë³¼ê¹Œìš”? ìƒˆë¡œìš´ ë„ì „ì„ í–¥í•´ í•œ ê±¸ìŒ ë” ë‚˜ì•„ê°€ë´ìš”.",
  "ê¸°ë¶„ ì¢‹ì€ ìƒê°ìœ¼ë¡œ ì‹œì‘í•´ë´ìš”! ê¸ì •ì ì¸ ë§ˆìŒì´ í•˜ë£¨ë¥¼ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
  "ë§¤ì¼ ë˜‘ê°™ì€ í•˜ë£¨ë¼ë„ ì˜¤ëŠ˜ì€ íŠ¹ë³„í•  ê±°ì˜ˆìš”! ì–´ì œì™€ ë‹¤ë¥¸ ë¬´ì–¸ê°€ë¥¼ ì°¾ì•„ë´ìš”.",
  "ì˜¤ëŠ˜ í•˜ë£¨ ì¤‘ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì€ ë¬´ì—‡ì¸ê°€ìš”? ì†Œì†Œí•œ ì¼ë„ ê¸°ì–µí•´ë³¼ê¹Œìš”?",
  "ì¡°ê¸ˆ í˜ë“¤ì—ˆë˜ ìˆœê°„ë„ ìˆì—ˆë‚˜ìš”? ê·¸ë˜ë„ ëê¹Œì§€ í•´ë‚¸ ë‹¹ì‹ ì´ ëŒ€ë‹¨í•©ë‹ˆë‹¤.",
  "ì–´ì œì™€ ë‹¤ë¥¸ ì˜¤ëŠ˜ì˜ íŠ¹ë³„í•¨ì„ ì°¾ì•„ë³´ì„¸ìš”! ì‚¬ì†Œí•œ ë³€í™”ë„ ì†Œì¤‘íˆ ì—¬ê²¨ë³´ì„¸ìš”.",
  "ì˜¤ëŠ˜ë„ ê¸°ë¡ì„ í†µí•´ ë‚˜ë¥¼ ëŒì•„ë³´ì„¸ìš”. ì‘ì€ ìˆœê°„ë“¤ì´ ëª¨ì—¬ íŠ¹ë³„í•œ í•˜ë£¨ê°€ ë©ë‹ˆë‹¤.",
  "í¬ê³  ëŒ€ë‹¨í•œ ì¼ì´ ì•„ë‹ˆì–´ë„ ì¢‹ì•„ìš”. ì˜¤ëŠ˜ ë‹¹ì‹ ì´ í•´ë‚¸ ì‘ì€ ì„±ì·¨ë¥¼ ê¸°ì–µí•´ë´ìš”.",
  "ë§¤ì¼ ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì°¾ì•„ì˜µë‹ˆë‹¤. ì˜¤ëŠ˜ë„ ë‚˜ë§Œì˜ ì†ë„ë¡œ ë‚˜ì•„ê°€ë©´ ì¶©ë¶„í•´ìš”.",
  "ì˜¤ëŠ˜ì˜ ê°ì •ì„ ì†”ì§í•˜ê²Œ ë‚¨ê²¨ë³´ì„¸ìš”. ê·¸ ê°ì •ë„ ì˜¤ëŠ˜ì˜ ì†Œì¤‘í•œ ì¼ë¶€ëë‹ˆë‹¤.",
  "ê¸°ì–µí•˜ê¸° ê·€ì°®ë‹¤ë©´ ì§€ê¸ˆ ê°„ë‹¨í•˜ê²Œ í•œ ì¤„ë¡œ ë‚¨ê²¨ë³´ì„¸ìš”. ì§§ì•„ë„ ë‹¹ì‹ ë§Œì˜ ì´ì•¼ê¸°ì˜ˆìš”.",
  "ì–´ì œì™€ ë‹¬ëë˜ ìˆœê°„ì„ í•œ ì¤„ë¡œ ë‚¨ê²¨ë³¼ê¹Œìš”? í‰ë²”í•´ ë³´ì´ì§€ë§Œ íŠ¹ë³„í•œ ê¸°ë¡ì´ ë  ê±°ì˜ˆìš”."
];

const currentUserId = "<%= user ? user.user_id : '' %>";
const MIN_INPUT_LENGTH = 10;

const prohibitedWords = [
  "ì”¨ë°œ", "ã……ã…‚", "ê°œìƒˆë¼", "ì¢†", "ì¡´ë‚˜", "ë‹¥ì³", "êº¼ì ¸", "ì£½ì–´", "ë’¤ì ¸",
  "fuck", "shit", "bitch", "wtf", "stfu", "idiot", "asshole", "ì°Œì§ˆ", "ì°ë”°", "ì •ì‹ ë³‘",
  "asdasd", "qweqwe", "zxcv", "ã…‹ã…‹ã…‹ã…‹ã…‹ã…‹", "ã…ã…ã…ã…ã…ã…", ".....", "ã…ã„´ã…‡ã„¹", "ã„±ã……ã„±ã……"
];

function getRandomGreeting() {
  const index = Math.floor(Math.random() * greetings.length);
  return greetings[index];
}

async function isInputValid(text) {
  const cleanedText = text.trim().toLowerCase();
  for (const word of prohibitedWords) {
    if (cleanedText.includes(word)) {
      console.warn("1ì°¨ í•„í„°ë§ ì°¨ë‹¨ ë‹¨ì–´:", word);
      return false;
    }
  }

  try {
    const response = await fetch('/api/check-abuse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });

    const data = await response.json();
    return data.result === "ì ì ˆí•¨";
  } catch (err) {
    console.error("OpenAI í•„í„°ë§ ì‹¤íŒ¨:", err);
    return true;
  }
}

let isHandling = false;

async function handleUserInput() {
  if (isHandling) return;
  isHandling = true;

  const userInput = document.getElementById("search-input").value;

  if (!currentUserId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
    window.location.href = "/login";
    isHandling = false;
    return;
  }

  if (userInput.length < MIN_INPUT_LENGTH) {
    alert(`ì…ë ¥í•œ ë¬¸ì¥ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìµœì†Œ ${MIN_INPUT_LENGTH}ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
    document.getElementById("search-input").value = "";
    isHandling = false;
    return;
  }

  const valid = await isInputValid(userInput);
  if (!valid) {
    alert("ë¶€ì ì ˆí•˜ê±°ë‚˜ ë¬´ì˜ë¯¸í•œ í‘œí˜„ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    document.getElementById("search-input").value = "";
    isHandling = false;
    return;
  }

  addLog(userInput, "right");

  try {
    const response = await fetch("/api/keyword-extract", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: userInput, user_id: currentUserId })
    });

    const data = await response.json();

    if (data.keyword) {
      alert(`ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ: ${data.keyword}`);

      await fetch("/api/chatlog", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: currentUserId,
          message: userInput,
          sender: "user"
        })
      });

      addLog(getRandomGreeting(), "left");
    } else {
      alert("í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    }
  } catch (err) {
    console.error("í‚¤ì›Œë“œ ì¶”ì¶œ ì˜¤ë¥˜:", err);
    addLog("í‚¤ì›Œë“œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "left");
  }

  document.getElementById("search-input").value = "";
  isHandling = false;
}

function addLog(text, position) {
  const logContainer = document.getElementById("log-container");
  const logItem = document.createElement("div");
  logItem.className = `log-item ${position}`;

  const messageText = document.createElement("p");
  messageText.innerText = text;

  const timestamp = document.createElement("span");
  timestamp.className = `timestamp ${position}`;
  timestamp.innerText = getCurrentTime();

  logItem.appendChild(messageText);
  logItem.appendChild(timestamp);
  logContainer.appendChild(logItem);
  logContainer.scrollTop = logContainer.scrollHeight;
}

function getCurrentTime() {
  const now = new Date();
  return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
}

async function fetchQuote() {
  try {
    const response = await fetch("https://korean-advice-open-api.vercel.app/api/advice");
    const data = await response.json();
    document.getElementById("quote-text").innerText = `"${data.message}"`;
    document.getElementById("quote-author").innerText = `- ${data.author} (${data.authorProfile})`;
  } catch (error) {
    document.getElementById("quote-text").innerText = "ëª…ì–¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
    document.getElementById("quote-author").innerText = "";
  }
}

async function loadRecentCommunities() {
  try {
    const response = await fetch('/api/community/recent');
    const data = await response.json();

    const listContainer = document.getElementById('recent-community-list');
    listContainer.innerHTML = '';

    data.forEach(map => {
      const name = map.user_id?.username || 'ìµëª…';
      const date = new Date(map.created_at).toLocaleDateString("ko-KR", {
        year: 'numeric', month: '2-digit', day: '2-digit'
      });

      const li = document.createElement('li');
      li.innerHTML = `
        <a href="/blockview/${map.map_id}" style="text-decoration: none; color: inherit;">
          <strong>${name}</strong> ë‹˜ì˜ ë¸”ë¡ ë§µ <small>${date}</small>
        </a>
      `;
      listContainer.appendChild(li);
    });
  } catch (err) {
    console.error("ìµœê·¼ ì»¤ë®¤ë‹ˆí‹° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    document.getElementById('recent-community-list').innerHTML = "<li>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</li>";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  addLog(getRandomGreeting(), "left");
  fetchQuote();
  loadRecentCommunities();

  document.getElementById("search-btn").addEventListener("click", handleUserInput);
  document.getElementById("search-input").addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      handleUserInput();
      event.preventDefault();
    }
  });
});
</script>
</body>
</html>
